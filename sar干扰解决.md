# 解决多SAR情形下的干扰问题

## 问题描述：

在调试smart sensor demo 板的时候，会用到4颗AW93208芯片（编号*1~4*），在调试过程中，发现*1*号芯片的**CH0**和**CH7**引脚会出现周期性的干扰，幅度占到正常触摸值的一半，如图:

> ![波形干扰图像](https://i.loli.net/2021/08/21/QdEUgilLDSyRe8M.png)
>
> 在没有触摸和接近的情况下，相较于**1_CH1~1_CH6**,**1_CH0**和**1_CH7**抖动特别厉害。

> 为表述方便**x_CHy**表示**x**号芯片的通道**y**，**x_CSy**表示**x**号芯片的pad **y**。

## 问题特征：

- **抖动幅特别大**
- **抖动频率很低，约${5s}$一次**

## 排查过程：

### 走线上，受到干扰的两个通道（**1_CH0**和**1_CH7**）中间夹着**3_CH6**和**3_CH7**，因此推测*3*号芯片对*1*号芯片造成了干扰。

- 不使能*3*，发现干扰消失，见下表：

| *1*号SAR | *2*号SAR | *3*号SAR | *4*号SAR | 抖动情况 |
| ---------- | ---------- | ---------- | ---------- | ---------- |
| 使能     | 使能     | *使能*   | 使能     | 抖动     |
| 使能     | 使能     | *不使能* | 使能     | 不抖动   |

因此可以排除*2*和*4*号SAR的嫌疑。

- 定位干扰位置，到底是在主板（控制板）还是在副板（图案板）;

> 图案板：
> ![图案板](https://i.loli.net/2021/08/21/Q6sZUIgD9clLJeB.png)

> 控制板：
> 尝试改变扫描相位，干扰还在。![控制板](https://i.loli.net/2021/08/21/DkhnaNM4Kbl5BiY.png)

SAR芯片在控制板中，通过插针连接图案板上的PAD，测量PAD的电容值来判断接近或者触控。

|        | A         | B         | C         | D         |
| -------- | ----------- | ----------- | ----------- | ----------- |
| 图案板 | **1_CS0** | **1_CS7** | **3_CS6** | **3_CS7** |
| 控制板 | **1_CH0** | **1_CH7** | **3_CH6** | **3_CH7** |

> 注：**1_CH0**在滑条的两端都有pad

**经过实验，发现取下图案板，干扰消失。**
**因此，干扰发生在图案板上，且由于3_CH6和3_CH7夹在被干扰信号之间，因此嫌疑最大。**

- 尝试不使用**3_CH6**和**3_CH7**，发现干扰还在。
- 尝试改变扫描周期，干扰还在。
- 尝试不使用**3_CS6**和**3_CS7**,干扰仍然存在。

## 观测扫描波形

- 使用逻辑分析仪依次连接**1_CH0**,**1_CH7**,**3_CH0**,**3_CH5**,**3_CS6**,**3_CS7**，观察电平变化。
- *1*号SAR扫描周期为22.12ms

![aw1扫描周期22.1ms](https://i.loli.net/2021/08/21/C5PcfImaSLX6JNy.png)

- *3*号SAR扫描周期为22.02ms

![aw3扫描周期22.02ms](https://i.loli.net/2021/08/21/7LJ4VeNRImx9PhG.png)

- **1_CH0**和**1_CH7**的扫描时刻若稍晚于**3_CH0**，则**3_CS6和3_CS7**的低电平就会与**1_CH0和1_CH7**形成较大的电容

![aw3_cs6~7低电平时间点](https://i.loli.net/2021/08/21/zinyScfo38MhaW5.png)

## 结论

至此，可以推测出，由于**3_CS6和3_CS7**接地后与**1_CH0**，**1_CH7**形成电容，导致这两个通道出现干扰波形。

解释干扰的两个特征：

- 抖动幅值大。

  > 根据电容计算公式：
  >
  > $$
  > C=\varepsilon_r{S \over 4 \pi kd}
  > $$
  >
  > ，当干扰源没有接地时，**1_CH0 1_CH7**与远处大地形成电容,容值应为0；当**3_CS6 3_CS7**接地时，相当于$d$急剧减小，形成一个较大$C$，因此测量的自容值会急剧升高，观测到一个脉冲。
  >
  > $$
  >
  > $$
- 抖动频率低，约${5s}$一次。

  > 根据测量结果，*1*号sar和*3*号sar的扫描周期分别为
  >
  > $$
  > T_1scan = 22.12ms
  > $$
  >
  > $$
  > T_3scan=22.02ms
  > $$
  >
  > 相差
  >
  > $$
  > \delta_{scan} = T_1scan - T_2scan = 0.1ms
  > $$
  >
  > 进一步可以推算出干扰周期
  >
  > $$
  > T = {T_3scan \over \delta_{scan}}\times T_1scan = 4.9s
  > $$

要解决这个问题，修改配置即可，根据寄存器表可知，对于**CH_x**，每一个**CS_y**都是可配的，在每个**CH_x**的扫描时间内，分时复用**CS_y**的不同配置。

|b1|b0|状态|
|-- |---|---- |
|0|0|高阻|
|0|1|CDC|
|1|0|shield|
|1|1|GND|

例如，若使用**3_CH_0**连接**3_CS_1**,则在**CH_0**的配置寄存器中，将**CS_1**配置成*01*，其它**CS**配置成*00*。
经过验证，所有*1~4*号SAR已无干扰现象。


